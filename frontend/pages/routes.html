<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Routes - Maritime Fleet Control</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <!-- leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(10, 22, 40, 0.9);
      backdrop-filter: blur(8px);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active { display: flex; }
    .modal-content {
      position: relative;
      z-index: 1001;
      background: linear-gradient(135deg, var(--ocean-dark), var(--ocean-medium));
      border-radius: 20px;
      border: 1px solid var(--dark-border);
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), 0 0 60px rgba(0, 212, 255, 0.2);
      animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    /* glowing line at top */
    .modal-content::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--secondary), var(--primary));
      background-size: 200% 100%;
      animation: shimmer 3s linear infinite;
      border-radius: 20px 20px 0 0;
    }
    @keyframes modalSlideIn {
      from { opacity: 0; transform: translateY(-30px) scale(0.95); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    /* permission notice styling */
    .permission-notice {
      padding: 16px 20px;
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 12px;
      margin-bottom: 24px;
      font-size: 14px;
      color: var(--primary);
      display: flex;
      align-items: center;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- sidebar navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="brand-icon">‚öì</div>
          <div class="brand-text"><h3>MARITIME</h3><p>FLEET CONTROL</p></div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
        <a href="fleet-map.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span>Fleet Map</span></a>
        <a href="vessels.html" class="nav-item"><span class="nav-icon">üö¢</span><span>Vessels</span></a>
        <a href="routes.html" class="nav-item active"><span class="nav-icon">üß≠</span><span>Routes</span></a>
        <a href="analytics.html" class="nav-item"><span class="nav-icon">üìà</span><span>Analytics</span></a>
        <a href="alerts.html" class="nav-item"><span class="nav-icon">üîî</span><span>Alerts</span></a>
        <a href="admin-panel.html" class="nav-item" id="adminLink" style="display:none;"><span class="nav-icon">üë•</span><span>Admin Panel</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">CA</div>
          <div class="user-details"><h4 id="userName">User</h4><p id="userRole">Role</p></div>
        </div>
        <button class="btn-logout" onclick="logout()">üö™ Logout</button>
      </div>
    </aside>

    <!-- main content area -->
    <main class="main-content">
      <div class="content-header">
        <div>
          <h1>üß≠ Route Management</h1>
          <p><span id="routeCount">0</span> routes configured</p>
        </div>
        <div class="header-actions">
          <span id="roleBadge" class="role-badge"></span>
          <button class="btn-add" id="addRouteBtn" onclick="openAddModal()" style="display:none;">‚ûï Add Route</button>
        </div>
      </div>

      <div class="content-body">
        <div class="permission-notice" id="permissionNotice"></div>
        
        <div style="display:grid;grid-template-columns:1fr 400px;gap:24px;">
          <!-- Routes Table -->
          <div class="table-container">
            <div class="table-header"><h3>All Routes</h3></div>
            <table class="data-table" id="routesTable">
              <thead>
                <tr>
                  <th>Route Name</th>
                  <th>Assigned Vessel</th>
                  <th>Waypoints</th>
                  <th>Risk Level</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="routesBody"></tbody>
            </table>
          </div>
          
          <!-- Route Preview Map -->
          <div class="table-container">
            <div class="table-header"><h3>Route Preview</h3></div>
            <div id="routeMap" style="height:400px;border-radius:8px;"></div>
            <div id="routeInfo" style="padding:16px;display:none;">
              <h4 id="previewRouteName" style="margin-bottom:8px;"></h4>
              <div id="waypointsList" style="font-size:13px;color:#64748b;"></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Add/Edit Route Modal -->
  <div id="routeModal" class="modal">
    <div class="modal-content" style="width:700px;">
      <div class="modal-header">
        <h2 id="modalTitle">Add Route</h2>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <form id="routeForm" onsubmit="saveRoute(event)">
        <div class="modal-body">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <div class="form-group">
              <label>Route Name *</label>
              <input type="text" id="routeName" required placeholder="e.g. Atlantic Express">
            </div>
            <div class="form-group">
              <label>Assign Vessel</label>
              <select id="vesselId">
                <option value="">-- No Vessel --</option>
              </select>
            </div>
            <div class="form-group">
              <label>Risk Level *</label>
              <select id="riskLevel" required>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            <div class="form-group">
              <label>Status *</label>
              <select id="routeStatus" required>
                <option value="planned">Planned</option>
                <option value="active">Active</option>
                <option value="completed">Completed</option>
              </select>
            </div>
          </div>
          
          <div class="form-group" style="margin-top:16px;">
            <label>Waypoints (click map or enter manually)</label>
            <div style="display:grid;grid-template-columns:1fr 200px;gap:16px;">
              <div id="waypointMap" style="height:300px;border-radius:8px;border:1px solid var(--dark-border);"></div>
              <div>
                <div id="waypointInputs" style="max-height:250px;overflow-y:auto;margin-bottom:8px;"></div>
                <button type="button" class="btn-secondary" style="width:100%;" onclick="addWaypointInput()">+ Add Waypoint</button>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
          <button type="submit" class="btn-save">üíæ Save Route</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // backend api url
    const API_URL = 'http://localhost:5000/api';
    let routes = [], vessels = [];
    let editingId = null;
    let previewMap, waypointMap;
    let previewLine, previewMarkers = [], waypointMarkers = [], waypointLine;
    let currentUser = null;
    
    // what each role can do
    const PERMISSIONS = {
      admin: { canAdd: true, canEdit: true, canDelete: true },
      operator: { canAdd: false, canEdit: false, canDelete: false },
      viewer: { canAdd: false, canEdit: false, canDelete: false }
    };
    
    // check if logged in
    function checkAuth() {
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      if (!token || !userStr) { window.location.href = 'login.html'; return null; }
      try { return JSON.parse(userStr); } catch (e) { window.location.href = 'login.html'; return null; }
    }
    
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    
    // get permissions for current user
    function getUserPermissions() {
      if (!currentUser) return PERMISSIONS.viewer;
      return PERMISSIONS[currentUser.role] || PERMISSIONS.viewer;
    }
    
    // helper to make api requests with auth token
    async function fetchAPI(url, options = {}) {
      const token = localStorage.getItem('token');
      const config = {
        ...options,
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}`, ...options.headers }
      };
      const res = await fetch(url, config);
      if (res.status === 401) { logout(); return null; }
      return res.json();
    }
    
    // badge html for risk level
    function getRiskBadge(risk) {
      const colors = { low: 'badge-success', medium: 'badge-warning', high: 'badge-danger' };
      return `<span class="badge ${colors[risk] || ''}">${risk}</span>`;
    }
    
    // badge html for status
    function getStatusBadge(status) {
      const colors = { planned: 'badge-default', active: 'badge-success', completed: 'badge-info' };
      return `<span class="badge ${colors[status] || ''}">${status}</span>`;
    }
    
    // get color for route line based on risk
    function getRiskColor(risk) {
      return { low: '#10b981', medium: '#f59e0b', high: '#ef4444' }[risk] || '#64748b';
    }
    
    // setup ui based on user role
    function setupRoleUI() {
      const perms = getUserPermissions();
      const role = currentUser?.role || 'viewer';

      // show role badge
      const roleBadge = document.getElementById('roleBadge');
      roleBadge.textContent = role.toUpperCase();
      roleBadge.className = `role-badge role-${role}`;

      // only show add button for admins
      document.getElementById('addRouteBtn').style.display = perms.canAdd ? 'flex' : 'none';

      // show permission notice
      const notice = document.getElementById('permissionNotice');
      if (role === 'admin') {
        notice.innerHTML = 'üîê <strong>Admin Access:</strong> You can add, edit, and delete routes.';
        notice.style.borderColor = 'rgba(0, 245, 212, 0.3)';
        notice.style.background = 'rgba(0, 245, 212, 0.1)';
        notice.style.color = '#00f5d4';
      } else if (role === 'operator') {
        notice.innerHTML = 'üîß <strong>Operator Access:</strong> You can view routes only. Contact admin to modify routes.';
        notice.style.borderColor = 'rgba(0, 212, 255, 0.3)';
        notice.style.background = 'rgba(0, 212, 255, 0.1)';
        notice.style.color = '#00d4ff';
      } else {
        notice.innerHTML = 'üëÅÔ∏è <strong>Viewer Access:</strong> You can view route information only.';
        notice.style.borderColor = 'rgba(255, 107, 107, 0.3)';
        notice.style.background = 'rgba(255, 107, 107, 0.1)';
        notice.style.color = '#ff6b6b';
      }
    }
    
    // create the preview map
    function initPreviewMap() {
      previewMap = L.map('routeMap').setView([30, -40], 2);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap ¬© CARTO'
      }).addTo(previewMap);
    }
    
    // load routes and vessels from api
    async function loadRoutes() {
      // fetch both at same time
      [routes, vessels] = await Promise.all([
        fetchAPI(`${API_URL}/routes`),
        fetchAPI(`${API_URL}/vessels`)
      ]);
      
      routes = Array.isArray(routes) ? routes : [];
      vessels = Array.isArray(vessels) ? vessels : [];
      
      document.getElementById('routeCount').textContent = routes.length;
      renderRoutes();
    }
    
    // render routes table
    function renderRoutes() {
      const perms = getUserPermissions();
      const tbody = document.getElementById('routesBody');
      
      if (routes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:40px;color:#64748b;">No routes found</td></tr>';
        return;
      }
      
      tbody.innerHTML = routes.map(r => {
        const vessel = vessels.find(v => v.id === r.vessel_id);
        const wpCount = r.waypoints ? r.waypoints.length : 0;
        
        // build action buttons based on what user can do
        let actions = `<button class="btn-icon btn-icon-view" onclick="previewRoute(${r.id})" title="Preview">üëÅÔ∏è</button>`;
        if (perms.canEdit) {
          actions += `<button class="btn-icon btn-icon-edit" onclick="openEditModal(${r.id})" title="Edit">‚úèÔ∏è</button>`;
        }
        if (perms.canDelete) {
          actions += `<button class="btn-icon btn-icon-danger" onclick="deleteRoute(${r.id})" title="Delete">üóëÔ∏è</button>`;
        }
        
        return `
          <tr>
            <td><strong>${r.route_name}</strong></td>
            <td>${vessel ? vessel.name : '<span style="color:#64748b;">Unassigned</span>'}</td>
            <td>${wpCount} points</td>
            <td>${getRiskBadge(r.risk_level)}</td>
            <td>${getStatusBadge(r.status)}</td>
            <td><div class="table-actions">${actions}</div></td>
          </tr>
        `;
      }).join('');
    }
    
    // show route on the preview map
    function previewRoute(id) {
      const route = routes.find(r => r.id === id);
      if (!route) return;
      
      // clear old stuff
      if (previewLine) previewMap.removeLayer(previewLine);
      previewMarkers.forEach(m => previewMap.removeLayer(m));
      previewMarkers = [];
      
      // draw route if it has waypoints
      if (route.waypoints && route.waypoints.length >= 2) {
        const latlngs = route.waypoints.map(wp => [wp.lat, wp.lng]);
        previewLine = L.polyline(latlngs, {
          color: getRiskColor(route.risk_level),
          weight: 4,
          opacity: 0.9
        }).addTo(previewMap);
        
        // add markers for each waypoint
        route.waypoints.forEach((wp, i) => {
          const marker = L.circleMarker([wp.lat, wp.lng], {
            radius: 6,
            color: '#fff',
            fillColor: getRiskColor(route.risk_level),
            fillOpacity: 1,
            weight: 2
          }).addTo(previewMap).bindPopup(`Waypoint ${i + 1}: ${wp.name || ''}`);
          previewMarkers.push(marker);
        });
        
        // zoom to fit the route
        previewMap.fitBounds(previewLine.getBounds().pad(0.2));
      }
      
      // show route info below map
      document.getElementById('routeInfo').style.display = 'block';
      document.getElementById('previewRouteName').textContent = route.route_name;
      document.getElementById('waypointsList').innerHTML = route.waypoints?.map((wp, i) => 
        `<p>${i + 1}. ${wp.name || 'Waypoint'} (${wp.lat.toFixed(4)}, ${wp.lng.toFixed(4)})</p>`
      ).join('') || 'No waypoints';
    }
    
    // open add modal - admin only
    function openAddModal() {
      if (!getUserPermissions().canAdd) {
        alert('You do not have permission to add routes.');
        return;
      }
      
      editingId = null;
      document.getElementById('modalTitle').textContent = 'Add New Route';
      document.getElementById('routeForm').reset();
      
      // fill vessel dropdown
      document.getElementById('vesselId').innerHTML = '<option value="">-- No Vessel --</option>' +
        vessels.map(v => `<option value="${v.id}">${v.name}</option>`).join('');
      
      // start with 2 waypoint inputs
      document.getElementById('waypointInputs').innerHTML = '';
      addWaypointInput();
      addWaypointInput();
      
      document.getElementById('routeModal').classList.add('active');
      
      // init map after modal opens
      setTimeout(() => {
        if (!waypointMap) {
          waypointMap = L.map('waypointMap').setView([30, -40], 2);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(waypointMap);
          waypointMap.on('click', onMapClick);
        }
        waypointMap.invalidateSize();
        clearWaypointVisuals();
      }, 100);
    }
    
    // open edit modal - admin only
    function openEditModal(id) {
      if (!getUserPermissions().canEdit) {
        alert('You do not have permission to edit routes.');
        return;
      }
      
      const route = routes.find(r => r.id === id);
      if (!route) return;
      
      editingId = id;
      document.getElementById('modalTitle').textContent = 'Edit Route';
      document.getElementById('routeName').value = route.route_name;
      document.getElementById('vesselId').innerHTML = '<option value="">-- No Vessel --</option>' +
        vessels.map(v => `<option value="${v.id}" ${v.id === route.vessel_id ? 'selected' : ''}>${v.name}</option>`).join('');
      document.getElementById('riskLevel').value = route.risk_level;
      document.getElementById('routeStatus').value = route.status;
      
      // load existing waypoints
      document.getElementById('waypointInputs').innerHTML = '';
      if (route.waypoints && route.waypoints.length > 0) {
        route.waypoints.forEach(wp => addWaypointInput(wp.lat, wp.lng, wp.name));
      } else {
        addWaypointInput();
        addWaypointInput();
      }
      
      document.getElementById('routeModal').classList.add('active');
      
      setTimeout(() => {
        if (!waypointMap) {
          waypointMap = L.map('waypointMap').setView([30, -40], 2);
          L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(waypointMap);
          waypointMap.on('click', onMapClick);
        }
        waypointMap.invalidateSize();
        updateWaypointVisuals();
      }, 100);
    }
    
    function closeModal() {
      document.getElementById('routeModal').classList.remove('active');
      editingId = null;
    }
    
    // counter for waypoint ids
    let waypointCounter = 0;
    
    // add a waypoint input row
    function addWaypointInput(lat = '', lng = '', name = '') {
      const id = waypointCounter++;
      const html = `
        <div class="waypoint-row" data-id="${id}" style="display:flex;gap:4px;margin-bottom:8px;">
          <input type="number" step="any" placeholder="Lat" value="${lat}" class="wp-lat" style="width:60px;padding:6px;background:var(--dark-bg);border:1px solid var(--dark-border);color:var(--text-primary);border-radius:4px;">
          <input type="number" step="any" placeholder="Lng" value="${lng}" class="wp-lng" style="width:60px;padding:6px;background:var(--dark-bg);border:1px solid var(--dark-border);color:var(--text-primary);border-radius:4px;">
          <button type="button" onclick="removeWaypoint(${id})" style="background:#ef4444;border:none;color:white;padding:6px 8px;border-radius:4px;cursor:pointer;">√ó</button>
        </div>
      `;
      document.getElementById('waypointInputs').insertAdjacentHTML('beforeend', html);
    }
    
    // remove a waypoint
    function removeWaypoint(id) {
      document.querySelector(`.waypoint-row[data-id="${id}"]`)?.remove();
      updateWaypointVisuals();
    }
    
    // when user clicks on map add waypoint there
    function onMapClick(e) {
      addWaypointInput(e.latlng.lat.toFixed(4), e.latlng.lng.toFixed(4));
      updateWaypointVisuals();
    }
    
    // clear markers and line from map
    function clearWaypointVisuals() {
      waypointMarkers.forEach(m => waypointMap.removeLayer(m));
      waypointMarkers = [];
      if (waypointLine) waypointMap.removeLayer(waypointLine);
    }
    
    // update map to show current waypoints
    function updateWaypointVisuals() {
      clearWaypointVisuals();
      
      const rows = document.querySelectorAll('.waypoint-row');
      const latlngs = [];
      
      rows.forEach((row, i) => {
        const lat = parseFloat(row.querySelector('.wp-lat').value);
        const lng = parseFloat(row.querySelector('.wp-lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          latlngs.push([lat, lng]);
          const marker = L.circleMarker([lat, lng], {
            radius: 8,
            color: '#fff',
            fillColor: '#0ea5e9',
            fillOpacity: 1,
            weight: 2
          }).addTo(waypointMap).bindPopup(`Waypoint ${i + 1}`);
          waypointMarkers.push(marker);
        }
      });
      
      // draw line if we have at least 2 points
      if (latlngs.length >= 2) {
        waypointLine = L.polyline(latlngs, { color: '#0ea5e9', weight: 3 }).addTo(waypointMap);
        waypointMap.fitBounds(waypointLine.getBounds().pad(0.2));
      }
    }
    
    // update map when inputs change
    document.getElementById('waypointInputs').addEventListener('input', updateWaypointVisuals);
    
    // save route - used for both add and edit
    async function saveRoute(e) {
      e.preventDefault();
      
      if (!getUserPermissions().canAdd && !getUserPermissions().canEdit) {
        alert('You do not have permission for this action.');
        return;
      }
      
      // get all waypoints from inputs
      const rows = document.querySelectorAll('.waypoint-row');
      const waypoints = [];
      rows.forEach((row, i) => {
        const lat = parseFloat(row.querySelector('.wp-lat').value);
        const lng = parseFloat(row.querySelector('.wp-lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          waypoints.push({ lat, lng, sequence: i + 1, name: `Waypoint ${i + 1}` });
        }
      });
      
      // build data object
      const data = {
        route_name: document.getElementById('routeName').value,
        vessel_id: document.getElementById('vesselId').value || null,
        risk_level: document.getElementById('riskLevel').value,
        status: document.getElementById('routeStatus').value,
        waypoints
      };
      
      // decide if add or edit
      const url = editingId ? `${API_URL}/routes/${editingId}` : `${API_URL}/routes`;
      const method = editingId ? 'PUT' : 'POST';
      
      const result = await fetchAPI(url, { method, body: JSON.stringify(data) });
      
      if (result && !result.error) {
        closeModal();
        loadRoutes();
        alert(editingId ? 'Route updated successfully!' : 'Route added successfully!');
        // tell other pages
        localStorage.setItem('routeUpdate', Date.now().toString());
      } else {
        alert(result?.message || 'Error saving route');
      }
    }
    
    // delete route - admin only
    async function deleteRoute(id) {
      if (!getUserPermissions().canDelete) {
        alert('You do not have permission to delete routes.');
        return;
      }
      
      const route = routes.find(r => r.id === id);
      if (!confirm(`Are you sure you want to delete route "${route?.route_name || 'this route'}"?`)) return;
      
      const result = await fetchAPI(`${API_URL}/routes/${id}`, { method: 'DELETE' });
      if (result && !result.error) {
        loadRoutes();
        alert('Route deleted successfully!');
        localStorage.setItem('routeUpdate', Date.now().toString());
      } else {
        alert(result?.message || 'Error deleting route');
      }
    }
    
    // reload when vessels change on another page
    window.addEventListener('storage', (e) => {
      if (e.key === 'vesselUpdate') {
        loadRoutes();
      }
    });
    
    // close modal when clicking outside
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          modal.classList.remove('active');
        }
      });
    });
    
    // runs when page loads
    document.addEventListener('DOMContentLoaded', () => {
      currentUser = checkAuth();
      if (!currentUser) return;
      
      // set user info in sidebar
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
      document.getElementById('userAvatar').textContent = currentUser.name.substring(0, 2).toUpperCase();
      if (currentUser.role === 'admin') document.getElementById('adminLink').style.display = 'flex';
      
      setupRoleUI();
      initPreviewMap();
      loadRoutes();
    });
  </script>
</body>
</html>
