<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fleet Map - Maritime Fleet Control</title>
  <!-- main styles -->
  <link rel="stylesheet" href="../assets/css/main.css">
  <!-- leaflet for the map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
  <div class="dashboard">
    <!-- sidebar navigation -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="brand-icon">⚓</div>
          <div class="brand-text"><h3>MARITIME</h3><p>FLEET CONTROL</p></div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item"><span class="nav-icon">📊</span><span>Dashboard</span></a>
        <a href="fleet-map.html" class="nav-item active"><span class="nav-icon">🗺️</span><span>Fleet Map</span></a>
        <a href="vessels.html" class="nav-item"><span class="nav-icon">🚢</span><span>Vessels</span></a>
        <a href="analytics.html" class="nav-item"><span class="nav-icon">📈</span><span>Analytics</span></a>
        <a href="alerts.html" class="nav-item"><span class="nav-icon">🔔</span><span>Alerts</span></a>
        <!-- only show for admins -->
        <a href="admin-panel.html" class="nav-item" id="adminLink" style="display:none;"><span class="nav-icon">👥</span><span>Admin Panel</span></a>
      </nav>
      <!-- user info at bottom -->
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">CA</div>
          <div class="user-details"><h4 id="userName">User</h4><p id="userRole">Role</p></div>
        </div>
        <button class="btn-logout" onclick="logout()">🚪 Logout</button>
      </div>
    </aside>

    <main class="main-content">
      <!-- page header -->
      <div class="content-header">
        <div>
          <h1>🗺️ Live Fleet Map</h1>
          <p><span id="vesselCount">0</span> vessels tracking • Auto-updates every 30s</p>
        </div>
      </div>

      <div class="content-body">
        <!-- map and fleet list side by side -->
        <div style="display: grid; grid-template-columns: 1fr 320px; gap: 24px;">
          <div>
            <!-- the actual map container -->
            <div id="map" style="height: 600px; border-radius: 16px; border: 1px solid var(--dark-border); box-shadow: 0 0 40px rgba(0, 212, 255, 0.1);"></div>
            <!-- legend showing what colors mean -->
            <div class="map-legend" style="margin-top: 16px; display: flex; gap: 24px; padding: 20px; background: linear-gradient(135deg, var(--ocean-dark), var(--ocean-medium)); border-radius: 12px; border: 1px solid var(--dark-border);">
              <div style="display:flex;align-items:center;gap:8px;"><span style="width:16px;height:16px;background:linear-gradient(135deg, #00d4ff, #0088cc);border-radius:50%;box-shadow:0 0 10px rgba(0,212,255,0.5);"></span> Cargo</div>
              <div style="display:flex;align-items:center;gap:8px;"><span style="width:16px;height:16px;background:linear-gradient(135deg, #00f5d4, #00c4a7);border-radius:50%;box-shadow:0 0 10px rgba(0,245,212,0.5);"></span> Naval</div>
              <div style="display:flex;align-items:center;gap:8px;"><span style="width:16px;height:16px;background:linear-gradient(135deg, #ffbe0b, #e6a200);border-radius:50%;box-shadow:0 0 10px rgba(255,190,11,0.5);"></span> Tanker</div>
              <div style="display:flex;align-items:center;gap:8px;"><span style="width:16px;height:16px;background:linear-gradient(135deg, #9d4edd, #7b2cbf);border-radius:50%;box-shadow:0 0 10px rgba(157,78,221,0.5);"></span> Submarine</div>
              <div style="margin-left:auto;display:flex;gap:16px;font-weight:500;">
                <span style="color:#00f5d4;">● Low Risk</span>
                <span style="color:#ffbe0b;">● Medium Risk</span>
                <span style="color:#ff6b6b;">● High Risk</span>
              </div>
            </div>
          </div>
          <!-- fleet list on the right side -->
          <div class="table-container" style="max-height: 680px; overflow-y: auto; background: linear-gradient(135deg, var(--ocean-dark), var(--ocean-medium));">
            <div class="table-header" style="background: rgba(0,0,0,0.2);"><h3>🚢 Fleet List</h3></div>
            <div id="fleetList"></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ============================================
    // MARITIME FLEET MAP - Enhanced Version
    // ============================================
    
    const API_URL = 'http://localhost:5000/api';
    
    // State Management
    const state = {
      map: null,
      vessels: new Map(),       // Map of vessel ID -> vessel data
      routes: new Map(),        // Map of route ID -> route data
      markers: new Map(),       // Map of vessel ID -> marker
      routeLines: new Map(),    // Map of route ID -> polyline
      vesselRouteLines: new Map(), // Map of vessel ID -> array of route lines
      isLoading: false,
      lastUpdate: null
    };
    
    // ============================================
    // AUTHENTICATION
    // ============================================
    function checkAuth() {
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      if (!token || !userStr) { 
        window.location.href = 'login.html'; 
        return null; 
      }
      try { 
        return JSON.parse(userStr); 
      } catch (e) { 
        window.location.href = 'login.html'; 
        return null; 
      }
    }
    
    function logout() { 
      localStorage.clear(); 
      window.location.href = 'login.html'; 
    }
    
    async function fetchAPI(url, options = {}) {
      try {
        const token = localStorage.getItem('token');
        const res = await fetch(url, { 
          ...options,
          headers: { 
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers 
          } 
        });
        if (res.status === 401) { 
          logout(); 
          return null; 
        }
        if (!res.ok) throw new Error('API error');
        return res.json();
      } catch (err) {
        console.error('Fetch error:', err);
        return null;
      }
    }
    
    // ============================================
    // COLORS AND STYLING
    // ============================================
    function getVesselColor(type) {
      const colors = { 
        Cargo: '#00d4ff', 
        Naval: '#00f5d4', 
        Tanker: '#ffbe0b', 
        Submarine: '#9d4edd' 
      };
      return colors[type] || '#64748b';
    }
    
    function getRiskColor(risk) {
      if (!risk) return '#64748b';
      const colors = { 
        low: '#00f5d4', 
        medium: '#ffbe0b', 
        high: '#ff6b6b',
        Low: '#00f5d4', 
        Medium: '#ffbe0b', 
        High: '#ff6b6b'
      };
      return colors[risk] || '#64748b';
    }
    
    function getVesselIcon(type) {
      const icons = { 
        Cargo: '🚢', 
        Naval: '⚓', 
        Tanker: '🛢️', 
        Submarine: '🌊' 
      };
      return icons[type] || '🚢';
    }
    
    // ============================================
    // SEA ROUTE GENERATION (Client-side fallback)
    // ============================================
    function generateLocalSeaRoute(startLat, startLng, endLat, endLng) {
      const waypoints = [];
      
      // Calculate distance and direction
      const latDiff = endLat - startLat;
      const lngDiff = endLng - startLng;
      const totalDistance = Math.sqrt(latDiff * latDiff + lngDiff * lngDiff);
      
      // Number of intermediate points based on distance
      const numPoints = Math.max(5, Math.min(20, Math.floor(totalDistance / 5)));
      
      for (let i = 0; i <= numPoints; i++) {
        const t = i / numPoints;
        
        // Base interpolation
        let lat = startLat + latDiff * t;
        let lng = startLng + lngDiff * t;
        
        // Add curve to simulate realistic sea navigation
        // Routes curve based on great circle approximation
        const curveIntensity = Math.sin(t * Math.PI) * Math.min(8, totalDistance / 10);
        
        // Calculate perpendicular offset direction
        const perpLat = -lngDiff / (totalDistance || 1);
        const perpLng = latDiff / (totalDistance || 1);
        
        // Apply curve - prefer ocean routes
        // Northern hemisphere: curve south for better shipping lanes
        // Southern hemisphere: curve north
        const hemisphereAdjust = lat > 0 ? -1 : 1;
        
        lat += perpLat * curveIntensity * 0.5;
        lng += perpLng * curveIntensity * 0.3;
        
        // Avoid major land masses
        // Africa (roughly)
        if (lng > -20 && lng < 50 && lat > -35 && lat < 35) {
          if (lat > 0) {
            lat = Math.max(lat, 36); // Go north around Mediterranean
          } else {
            lat = Math.min(lat, -36); // Go south around Cape
          }
        }
        
        // South America
        if (lng > -82 && lng < -34 && lat > -56 && lat < 12) {
          if (lng < -60) {
            // Pacific side - go further west
            lng = Math.min(lng, -85);
          } else {
            // Atlantic side - go further east
            lng = Math.max(lng, -30);
          }
        }
        
        // North America (east coast)
        if (lng > -82 && lng < -60 && lat > 25 && lat < 50) {
          lng = Math.max(lng, -55);
        }
        
        waypoints.push({ lat, lng });
      }
      
      return waypoints;
    }
    
    async function generateSeaRouteWaypoints(startLat, startLng, endLat, endLng) {
      // Try server-side generation first
      try {
        const result = await fetchAPI(`${API_URL}/routes/generate-sea-route`, {
          method: 'POST',
          body: JSON.stringify({ startLat, startLng, endLat, endLng })
        });
        
        if (result && result.waypoints) {
          return result.waypoints;
        }
      } catch (error) {
        console.warn('Server sea route generation failed, using local fallback');
      }
      
      // Fallback to client-side generation
      return generateLocalSeaRoute(startLat, startLng, endLat, endLng);
    }
    
    // ============================================
    // MAP INITIALIZATION
    // ============================================
    function initMap() {
      state.map = L.map('map').setView([30, -40], 3);
      
      // Dark theme tiles
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap © CARTO',
        maxZoom: 18
      }).addTo(state.map);
      
      console.log('Map initialized');
    }
    
    // ============================================
    // MARKER MANAGEMENT
    // ============================================
    function createVesselMarker(vessel) {
      const lat = parseFloat(vessel.latitude);
      const lng = parseFloat(vessel.longitude);
      
      if (isNaN(lat) || isNaN(lng) || lat < -90 || lat > 90 || lng < -180 || lng > 180) {
        console.warn(`Invalid coordinates for vessel ${vessel.name}`);
        return null;
      }
      
      const color = getVesselColor(vessel.type);
      const icon = L.divIcon({
        className: 'vessel-marker',
        html: `<div style="
          width: 36px;
          height: 36px;
          background: ${color};
          border: 3px solid white;
          border-radius: 50%;
          box-shadow: 0 2px 10px rgba(0,0,0,0.5), 0 0 20px ${color}60;
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 18px;
          transition: transform 0.3s ease;
        " onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">${getVesselIcon(vessel.type)}</div>`,
        iconSize: [36, 36],
        iconAnchor: [18, 18]
      });
      
      const marker = L.marker([lat, lng], { icon }).addTo(state.map);
      
      marker.bindPopup(`
        <div style="min-width: 220px; font-family: Inter, sans-serif;">
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            <span style="font-size: 24px;">${getVesselIcon(vessel.type)}</span>
            <div>
              <strong style="font-size: 16px; color: #0a1628;">${vessel.name}</strong>
              <div style="color: ${color}; font-weight: 600; font-size: 12px;">${vessel.type}</div>
            </div>
          </div>
          <hr style="margin: 8px 0; border-color: #e0e0e0;">
          <div style="font-size: 13px; line-height: 1.8; color: #374151;">
            <div><strong>Speed:</strong> ${vessel.speed || 0} knots</div>
            <div><strong>Engine:</strong> <span style="color: ${vessel.engine_health >= 80 ? '#10b981' : vessel.engine_health >= 50 ? '#f59e0b' : '#ef4444'}">${vessel.engine_health || 0}%</span></div>
            <div><strong>Fuel:</strong> <span style="color: ${(vessel.fuel_level || 0) >= 50 ? '#10b981' : (vessel.fuel_level || 0) >= 20 ? '#f59e0b' : '#ef4444'}">${vessel.fuel_level || 0}%</span></div>
            <div><strong>Status:</strong> <span style="color: ${vessel.status === 'Active' ? '#10b981' : '#f59e0b'}">${vessel.status}</span></div>
            <div style="margin-top: 5px; font-size: 11px; color: #6b7280;">
              📍 ${lat.toFixed(4)}, ${lng.toFixed(4)}
            </div>
          </div>
        </div>
      `);
      
      marker.vesselId = vessel.id;
      return marker;
    }
    
    function removeVesselMarker(vesselId) {
      const marker = state.markers.get(vesselId);
      if (marker) {
        state.map.removeLayer(marker);
        state.markers.delete(vesselId);
        console.log(`Removed marker for vessel ${vesselId}`);
      }
    }
    
    // ============================================
    // ROUTE LINE MANAGEMENT
    // ============================================
    function createRouteLine(route) {
      if (!route.waypoints || route.waypoints.length < 2) {
        return null;
      }
      
      const latlngs = route.waypoints.map(wp => {
        // Handle both {lat, lng} and [lat, lng] formats
        if (Array.isArray(wp)) return wp;
        return [wp.lat, wp.lng];
      });
      
      const color = getRiskColor(route.risk_level);
      
      const polyline = L.polyline(latlngs, {
        color: color,
        weight: 3,
        opacity: 0.8,
        dashArray: '8, 6',
        lineCap: 'round',
        lineJoin: 'round'
      }).addTo(state.map);
      
      polyline.bindPopup(`
        <div style="min-width: 180px; font-family: Inter, sans-serif;">
          <strong style="font-size: 14px; color: #0a1628;">🧭 ${route.route_name}</strong>
          <hr style="margin: 8px 0; border-color: #e0e0e0;">
          <div style="font-size: 13px; line-height: 1.6; color: #374151;">
            <div><strong>Risk:</strong> <span style="color: ${color}">${route.risk_level || 'Unknown'}</span></div>
            <div><strong>Status:</strong> ${route.status || 'Planned'}</div>
            ${route.vessel_name ? `<div><strong>Vessel:</strong> ${route.vessel_name}</div>` : '<div style="color: #9ca3af;">No vessel assigned</div>'}
            <div><strong>Waypoints:</strong> ${route.waypoints.length}</div>
          </div>
        </div>
      `);
      
      polyline.routeId = route.id;
      polyline.vesselId = route.vessel_id;
      return polyline;
    }
    
    function removeRouteLine(routeId) {
      const line = state.routeLines.get(routeId);
      if (line) {
        state.map.removeLayer(line);
        state.routeLines.delete(routeId);
        console.log(`Removed route line ${routeId}`);
      }
    }
    
    function removeVesselRouteLines(vesselId) {
      // Remove all routes associated with a vessel
      state.routeLines.forEach((line, routeId) => {
        if (line.vesselId === vesselId) {
          state.map.removeLayer(line);
          state.routeLines.delete(routeId);
          console.log(`Removed route ${routeId} for vessel ${vesselId}`);
        }
      });
    }
    
    function clearAllRouteLines() {
      state.routeLines.forEach((line, routeId) => {
        state.map.removeLayer(line);
      });
      state.routeLines.clear();
      console.log('Cleared all route lines');
    }
    
    function clearAllMarkers() {
      state.markers.forEach((marker, vesselId) => {
        state.map.removeLayer(marker);
      });
      state.markers.clear();
      console.log('Cleared all markers');
    }
    
    // ============================================
    // DATA LOADING AND SYNCHRONIZATION
    // ============================================
    async function loadMapData() {
      if (state.isLoading) return;
      state.isLoading = true;
      
      console.log('Loading map data...');
      
      try {
        const [vessels, routes] = await Promise.all([
          fetchAPI(`${API_URL}/vessels`),
          fetchAPI(`${API_URL}/routes`)
        ]);
        
        // Process vessels
        const newVesselIds = new Set();
        const currentVesselIds = new Set(state.vessels.keys());
        
        if (vessels && vessels.length > 0) {
          vessels.forEach(vessel => {
            newVesselIds.add(vessel.id);
            const existingVessel = state.vessels.get(vessel.id);
            
            if (!existingVessel) {
              // New vessel - create marker
              const marker = createVesselMarker(vessel);
              if (marker) {
                state.markers.set(vessel.id, marker);
              }
              state.vessels.set(vessel.id, vessel);
              console.log(`Added new vessel: ${vessel.name}`);
            } else if (hasVesselChanged(existingVessel, vessel)) {
              // Vessel updated - update marker
              removeVesselMarker(vessel.id);
              const marker = createVesselMarker(vessel);
              if (marker) {
                state.markers.set(vessel.id, marker);
              }
              state.vessels.set(vessel.id, vessel);
              console.log(`Updated vessel: ${vessel.name}`);
            }
          });
        }
        
        // Remove deleted vessels and their routes
        currentVesselIds.forEach(vesselId => {
          if (!newVesselIds.has(vesselId)) {
            const vessel = state.vessels.get(vesselId);
            console.log(`Removing deleted vessel: ${vessel?.name || vesselId}`);
            removeVesselMarker(vesselId);
            removeVesselRouteLines(vesselId);
            state.vessels.delete(vesselId);
          }
        });
        
        // Process routes
        const newRouteIds = new Set();
        const currentRouteIds = new Set(state.routes.keys());
        
        // Clear and rebuild route lines for consistency
        clearAllRouteLines();
        state.routes.clear();
        
        // Only show routes if there are vessels AND the route is assigned to an existing vessel
        if (routes && routes.length > 0 && vessels && vessels.length > 0) {
          // Create a set of existing vessel IDs for quick lookup
          const existingVesselIds = new Set(vessels.map(v => v.id));
          
          for (const route of routes) {
            newRouteIds.add(route.id);
            
            // Only show routes that:
            // 1. Have valid waypoints (at least 2)
            // 2. Are assigned to a vessel that still exists
            const hasValidWaypoints = route.waypoints && route.waypoints.length >= 2;
            const hasExistingVessel = route.vessel_id && existingVesselIds.has(route.vessel_id);
            
            if (hasValidWaypoints && hasExistingVessel) {
              const line = createRouteLine(route);
              if (line) {
                state.routeLines.set(route.id, line);
              }
            }
            state.routes.set(route.id, route);
          }
        }
        
        // Update UI
        updateFleetList(vessels || []);
        document.getElementById('vesselCount').textContent = state.markers.size;
        
        state.lastUpdate = new Date();
        console.log(`Map data loaded: ${state.markers.size} vessels, ${state.routeLines.size} routes`);
        
      } catch (error) {
        console.error('Error loading map data:', error);
      } finally {
        state.isLoading = false;
      }
    }
    
    function hasVesselChanged(oldVessel, newVessel) {
      return oldVessel.latitude !== newVessel.latitude ||
             oldVessel.longitude !== newVessel.longitude ||
             oldVessel.status !== newVessel.status ||
             oldVessel.engine_health !== newVessel.engine_health ||
             oldVessel.fuel_level !== newVessel.fuel_level ||
             oldVessel.speed !== newVessel.speed;
    }
    
    // ============================================
    // FLEET LIST UI
    // ============================================
    function updateFleetList(vessels) {
      const listDiv = document.getElementById('fleetList');
      
      if (!vessels || vessels.length === 0) {
        listDiv.innerHTML = `
          <div style="padding: 40px 20px; text-align: center;">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">🚢</div>
            <p style="color: var(--text-secondary); margin-bottom: 8px;">No vessels found</p>
            <p style="color: var(--text-tertiary); font-size: 12px;">Add vessels from the Vessels page</p>
          </div>
        `;
        return;
      }
      
      listDiv.innerHTML = vessels.map(v => {
        const color = getVesselColor(v.type);
        const isValid = !isNaN(parseFloat(v.latitude)) && !isNaN(parseFloat(v.longitude));
        
        return `
          <div class="fleet-list-item" onclick="focusVessel(${v.id})" 
               style="padding: 14px 16px; border-bottom: 1px solid var(--border); cursor: pointer; transition: all 0.2s;"
               onmouseover="this.style.background='rgba(0,212,255,0.08)'; highlightVessel(${v.id}, true)" 
               onmouseout="this.style.background='transparent'; highlightVessel(${v.id}, false)">
            <div style="display: flex; align-items: center; gap: 12px;">
              <div style="
                width: 36px;
                height: 36px;
                background: ${color};
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
                box-shadow: 0 0 12px ${color}40;
              ">${getVesselIcon(v.type)}</div>
              <div style="flex: 1; min-width: 0;">
                <strong style="font-size: 14px; color: var(--text-primary); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${v.name}</strong>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 2px;">
                  ${v.type} • ${v.speed || 0} kn
                </div>
                <div style="font-size: 11px; color: var(--text-tertiary); margin-top: 2px;">
                  🔧 ${v.engine_health}% • ⛽ ${v.fuel_level || 0}%
                </div>
              </div>
              <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                <span style="
                  padding: 3px 8px;
                  border-radius: 8px;
                  background: ${v.status === 'Active' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)'};
                  color: ${v.status === 'Active' ? '#10b981' : '#f59e0b'};
                  font-size: 10px;
                  font-weight: 600;
                ">${v.status}</span>
                ${!isValid ? '<span style="font-size: 10px; color: #ef4444;">⚠️ No GPS</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ============================================
    // USER INTERACTIONS
    // ============================================
    function focusVessel(vesselId) {
      const vessel = state.vessels.get(vesselId);
      if (!vessel) return;
      
      const lat = parseFloat(vessel.latitude);
      const lng = parseFloat(vessel.longitude);
      
      if (!isNaN(lat) && !isNaN(lng)) {
        state.map.setView([lat, lng], 8, { animate: true });
        
        // Open popup
        const marker = state.markers.get(vesselId);
        if (marker) {
          marker.openPopup();
        }
      }
    }
    
    function highlightVessel(vesselId, highlight) {
      const marker = state.markers.get(vesselId);
      if (!marker) return;
      
      const icon = marker.getElement();
      if (icon) {
        const innerDiv = icon.querySelector('div');
        if (innerDiv) {
          innerDiv.style.transform = highlight ? 'scale(1.3)' : 'scale(1)';
          innerDiv.style.boxShadow = highlight 
            ? '0 0 25px rgba(0, 212, 255, 0.8)' 
            : '0 2px 10px rgba(0,0,0,0.5)';
        }
      }
    }
    
    function refreshMap() {
      console.log('Manual refresh triggered');
      loadMapData();
    }
    
    // ============================================
    // REAL-TIME UPDATES
    // ============================================
    function setupRealtimeUpdates() {
      // Listen for changes from other tabs/pages
      window.addEventListener('storage', (e) => {
        if (e.key === 'vesselUpdate' || e.key === 'routeUpdate' || e.key === 'fleetUpdate') {
          console.log('Storage event detected, refreshing map...');
          setTimeout(loadMapData, 100);
        }
      });
      
      // Custom event listener for same-page updates
      window.addEventListener('fleetDataChanged', () => {
        console.log('Fleet data changed event, refreshing...');
        loadMapData();
      });
      
      // Auto-refresh every 30 seconds
      setInterval(() => {
        console.log('Auto-refresh...');
        loadMapData();
      }, 30000);
    }
    
    // Broadcast update to other tabs
    function broadcastUpdate(type) {
      localStorage.setItem(type, Date.now().toString());
      window.dispatchEvent(new Event('fleetDataChanged'));
    }
    
    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', () => {
      const user = checkAuth();
      if (!user) return;
      
      // Show user info
      document.getElementById('userName').textContent = user.name || user.email;
      document.getElementById('userRole').textContent = user.role.toUpperCase();
      document.getElementById('userAvatar').textContent = (user.name || user.email).substring(0, 2).toUpperCase();
      
      if (user.role === 'admin') {
        document.getElementById('adminLink').style.display = 'flex';
      }
      
      // Initialize map and load data
      initMap();
      loadMapData();
      setupRealtimeUpdates();
      
      console.log('Fleet map initialized');
    });
    
    // Make functions globally accessible
    window.focusVessel = focusVessel;
    window.highlightVessel = highlightVessel;
    window.refreshMap = refreshMap;
    window.logout = logout;
  </script>
</body>
</html>