<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analytics - Maritime Fleet Control</title>
  <link rel="stylesheet" href="../assets/css/main.css">
  <!-- chart.js for all the graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="dashboard">
    <!-- sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="brand-icon">‚öì</div>
          <div class="brand-text"><h3>MARITIME</h3><p>FLEET CONTROL</p></div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-item"><span class="nav-icon">üìä</span><span>Dashboard</span></a>
        <a href="fleet-map.html" class="nav-item"><span class="nav-icon">üó∫Ô∏è</span><span>Fleet Map</span></a>
        <a href="vessels.html" class="nav-item"><span class="nav-icon">üö¢</span><span>Vessels</span></a>
        <a href="analytics.html" class="nav-item active"><span class="nav-icon">üìà</span><span>Analytics</span></a>
        <a href="alerts.html" class="nav-item"><span class="nav-icon">üîî</span><span>Alerts</span></a>
        <a href="admin-panel.html" class="nav-item" id="adminLink" style="display:none;"><span class="nav-icon">üë•</span><span>Admin Panel</span></a>
      </nav>
      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar" id="userAvatar">CA</div>
          <div class="user-details"><h4 id="userName">User</h4><p id="userRole">Role</p></div>
        </div>
        <button class="btn-logout" onclick="logout()">üö™ Logout</button>
      </div>
    </aside>

    <!-- main content -->
    <main class="main-content">
      <div class="content-header">
        <div>
          <h1>üìà Fleet Analytics</h1>
          <p>Real-time performance metrics from database</p>
        </div>

      </div>

      <div class="content-body">
        <!-- summary stats at top -->
        <div class="stats-grid" style="margin-bottom:24px;">
          <div class="stat-card">
            <div class="stat-icon blue">üö¢</div>
            <div class="stat-details"><p>Total Vessels</p><h3 id="totalVessels">0</h3></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon teal">‚úÖ</div>
            <div class="stat-details"><p>Avg Engine Health</p><h3 id="avgHealth">0%</h3></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon yellow">‚õΩ</div>
            <div class="stat-details"><p>Avg Fuel Level</p><h3 id="avgFuel">0%</h3></div>
          </div>
          <div class="stat-card">
            <div class="stat-icon red">üö®</div>
            <div class="stat-details"><p>Active Alerts</p><h3 id="activeAlerts">0</h3></div>
          </div>
        </div>

        <!-- first row of charts -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px;">
          <div class="table-container">
            <div class="table-header"><h3>üö¢ Fleet by Type</h3></div>
            <div style="padding:24px;height:300px;"><canvas id="vesselTypeChart"></canvas></div>
          </div>
          <div class="table-container">
            <div class="table-header"><h3>üìä Vessel Status Distribution</h3></div>
            <div style="padding:24px;height:300px;"><canvas id="statusChart"></canvas></div>
          </div>
        </div>

        <!-- second row of charts -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:24px;">
          <div class="table-container">
            <div class="table-header"><h3>Engine Health by Vessel</h3></div>
            <div style="padding:20px;height:300px;"><canvas id="engineHealthChart"></canvas></div>
          </div>
          <div class="table-container">
            <div class="table-header"><h3>Route Risk Assessment</h3></div>
            <div style="padding:20px;height:300px;"><canvas id="routeRiskChart"></canvas></div>
          </div>
        </div>

        <!-- third row -->
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:24px;">
          <div class="table-container">
            <div class="table-header"><h3>Alert Types Breakdown</h3></div>
            <div style="padding:20px;height:300px;"><canvas id="alertTypesChart"></canvas></div>
          </div>
          <div class="table-container">
            <div class="table-header"><h3>Fleet Performance Summary</h3></div>
            <div style="padding:20px;" id="performanceSummary"></div>
          </div>
        </div>

      </div>
    </main>
  </div>

  <script>
    // api url
    const API_URL = 'http://localhost:5000/api';
    let charts = {};
    
    // check if logged in
    function checkAuth() {
      const token = localStorage.getItem('token');
      const userStr = localStorage.getItem('user');
      if (!token || !userStr) { window.location.href = 'login.html'; return null; }
      try { return JSON.parse(userStr); } catch (e) { window.location.href = 'login.html'; return null; }
    }
    
    function logout() { localStorage.clear(); window.location.href = 'login.html'; }
    
    // fetch with auth header
    async function fetchAPI(url) {
      const token = localStorage.getItem('token');
      const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
      if (res.status === 401) { logout(); return null; }
      return res.ok ? res.json() : null;
    }
    
    // colors for charts
    const chartColors = {
      blue: '#0ea5e9',
      green: '#10b981',
      yellow: '#f59e0b',
      red: '#ef4444',
      purple: '#8b5cf6',
      pink: '#ec4899',
      cyan: '#06b6d4',
      gray: '#64748b'
    };
    
    // main function to load all analytics
    async function loadAnalytics() {
      // get all data at once
      const [vessels, routes, alerts] = await Promise.all([
        fetchAPI(`${API_URL}/vessels`),
        fetchAPI(`${API_URL}/routes`),
        fetchAPI(`${API_URL}/alerts`)
      ]);
      
      if (!vessels) return;
      
      // update summary stats
      document.getElementById('totalVessels').textContent = vessels.length;
      
      // calculate average health
      const avgHealth = vessels.length > 0 
        ? Math.round(vessels.reduce((sum, v) => sum + (v.engine_health || 0), 0) / vessels.length)
        : 0;
      document.getElementById('avgHealth').textContent = avgHealth + '%';
      
      // calculate average fuel
      const avgFuel = vessels.length > 0 
        ? Math.round(vessels.reduce((sum, v) => sum + (v.fuel_level || 0), 0) / vessels.length)
        : 0;
      document.getElementById('avgFuel').textContent = avgFuel + '%';
      
      const activeAlertCount = alerts ? alerts.filter(a => a.status === 'active').length : 0;
      document.getElementById('activeAlerts').textContent = activeAlertCount;
      
      // vessel type chart - doughnut
      // destroy old chart if exists
      if (charts.vesselType) charts.vesselType.destroy();
      
      if (vessels.length > 0) {
        const typeCounts = {};
        vessels.forEach(v => { typeCounts[v.type] = (typeCounts[v.type] || 0) + 1; });
        
        charts.vesselType = new Chart(document.getElementById('vesselTypeChart'), {
          type: 'doughnut',
          data: {
            labels: Object.keys(typeCounts),
            datasets: [{
              data: Object.values(typeCounts),
              backgroundColor: [chartColors.blue, chartColors.green, chartColors.yellow, chartColors.purple, chartColors.pink],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#e2e8f0' } }
            }
          }
        });
      } else {
        document.getElementById('vesselTypeChart').parentElement.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#64748b;">
            <span style="font-size:48px;opacity:0.5;">üö¢</span>
            <p style="margin-top:12px;">No vessels to display</p>
          </div>
        `;
      }
      
      // status distribution - pie chart
      if (charts.status) charts.status.destroy();
      
      if (vessels.length > 0) {
        const statusCounts = {};
        vessels.forEach(v => { statusCounts[v.status] = (statusCounts[v.status] || 0) + 1; });
        
        charts.status = new Chart(document.getElementById('statusChart'), {
          type: 'pie',
          data: {
            labels: Object.keys(statusCounts),
            datasets: [{
              data: Object.values(statusCounts),
              backgroundColor: [chartColors.green, chartColors.gray, chartColors.yellow],
              borderWidth: 0
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom', labels: { color: '#e2e8f0' } }
            }
          }
        });
      } else {
        document.getElementById('statusChart').parentElement.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#64748b;">
            <span style="font-size:48px;opacity:0.5;">üìä</span>
            <p style="margin-top:12px;">No status data available</p>
          </div>
        `;
      }
      
      // engine health - horizontal bar
      if (charts.engineHealth) charts.engineHealth.destroy();
      
      if (vessels.length > 0) {
        charts.engineHealth = new Chart(document.getElementById('engineHealthChart'), {
          type: 'bar',
          data: {
            labels: vessels.map(v => v.name),
            datasets: [{
              label: 'Engine Health %',
              data: vessels.map(v => v.engine_health || 0),
              // color based on health level
              backgroundColor: vessels.map(v => {
                const h = v.engine_health || 0;
                return h >= 80 ? chartColors.green : h >= 50 ? chartColors.yellow : chartColors.red;
              }),
              borderRadius: 4
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: { max: 100, grid: { color: '#334155' }, ticks: { color: '#94a3b8' } },
              y: { grid: { display: false }, ticks: { color: '#e2e8f0' } }
            },
            plugins: { legend: { display: false } }
          }
        });
      } else {
        document.getElementById('engineHealthChart').parentElement.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#64748b;">
            <span style="font-size:48px;opacity:0.5;">üîß</span>
            <p style="margin-top:12px;">No engine data available</p>
          </div>
        `;
      }
      
      // route risk chart - only show if there are vessels
      if (charts.routeRisk) charts.routeRisk.destroy();
      
      if (vessels && vessels.length > 0 && routes && routes.length > 0) {
        // Only count routes that are assigned to existing vessels
        const vesselIds = new Set(vessels.map(v => v.id));
        const assignedRoutes = routes.filter(r => r.vessel_id && vesselIds.has(r.vessel_id));
        
        if (assignedRoutes.length > 0) {
          const riskCounts = { low: 0, medium: 0, high: 0 };
          assignedRoutes.forEach(r => { riskCounts[r.risk_level] = (riskCounts[r.risk_level] || 0) + 1; });
          
          charts.routeRisk = new Chart(document.getElementById('routeRiskChart'), {
            type: 'bar',
            data: {
              labels: ['Low Risk', 'Medium Risk', 'High Risk'],
              datasets: [{
                label: 'Routes',
                data: [riskCounts.low, riskCounts.medium, riskCounts.high],
                backgroundColor: [chartColors.green, chartColors.yellow, chartColors.red],
                borderRadius: 8
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: { beginAtZero: true, grid: { color: '#334155' }, ticks: { color: '#94a3b8', stepSize: 1 } },
                x: { grid: { display: false }, ticks: { color: '#e2e8f0' } }
              },
              plugins: { legend: { display: false } }
            }
          });
        } else {
          // Show "no assigned routes" message
          document.getElementById('routeRiskChart').parentElement.innerHTML = `
            <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#64748b;">
              <span style="font-size:48px;opacity:0.5;">üß≠</span>
              <p style="margin-top:12px;">No routes assigned to vessels</p>
            </div>
          `;
        }
      } else {
        // Show "no data" message when no vessels
        document.getElementById('routeRiskChart').parentElement.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#64748b;">
            <span style="font-size:48px;opacity:0.5;">üìä</span>
            <p style="margin-top:12px;">No vessels to analyze</p>
          </div>
        `;
      }
      
      // alert types chart - polar area (looks cool)
      if (charts.alertTypes) charts.alertTypes.destroy();
      
      if (alerts && alerts.length > 0) {
        const alertTypes = {};
        alerts.forEach(a => { alertTypes[a.alert_type] = (alertTypes[a.alert_type] || 0) + 1; });
        
        charts.alertTypes = new Chart(document.getElementById('alertTypesChart'), {
          type: 'polarArea',
          data: {
            labels: Object.keys(alertTypes),
            datasets: [{
              data: Object.values(alertTypes),
              // semi transparent colors
              backgroundColor: [
                'rgba(14, 165, 233, 0.7)',
                'rgba(239, 68, 68, 0.7)',
                'rgba(245, 158, 11, 0.7)',
                'rgba(139, 92, 246, 0.7)',
                'rgba(16, 185, 129, 0.7)'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: { grid: { color: '#334155' }, ticks: { color: '#94a3b8', backdropColor: 'transparent' } }
            },
            plugins: {
              legend: { position: 'right', labels: { color: '#e2e8f0' } }
            }
          }
        });
      } else {
        document.getElementById('alertTypesChart').parentElement.innerHTML = `
          <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;color:#64748b;">
            <span style="font-size:48px;opacity:0.5;">üîî</span>
            <p style="margin-top:12px;">No alerts recorded</p>
          </div>
        `;
      }
      
      // performance summary section
      // shows key stats about the fleet
      const criticalVessels = vessels.filter(v => v.engine_health < 50).length;
      const lowFuelVessels = vessels.filter(v => (v.fuel_level || 0) < 20).length;
      const activeVessels = vessels.filter(v => v.status === 'Active').length;
      
      // build the summary html
      document.getElementById('performanceSummary').innerHTML = `
        <div style="space-y:12px;">
          <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--dark-border);">
            <span style="color:#64748b;">Active Vessels</span>
            <span style="font-weight:600;color:#10b981;">${activeVessels} / ${vessels.length}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--dark-border);">
            <span style="color:#64748b;">Fleet Utilization</span>
            <span style="font-weight:600;">${vessels.length > 0 ? Math.round((activeVessels/vessels.length)*100) : 0}%</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--dark-border);">
            <span style="color:#64748b;">Critical Engine Issues</span>
            <span style="font-weight:600;color:${criticalVessels > 0 ? '#ef4444' : '#10b981'};">${criticalVessels}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--dark-border);">
            <span style="color:#64748b;">Low Fuel Warning</span>
            <span style="font-weight:600;color:${lowFuelVessels > 0 ? '#f59e0b' : '#10b981'};">${lowFuelVessels}</span>
          </div>
          <div style="display:flex;justify-content:space-between;padding:12px 0;">
            <span style="color:#64748b;">Total Routes</span>
            <span style="font-weight:600;">${routes?.length || 0}</span>
          </div>
        </div>
      `;
    }
    
    // listen for updates from other pages
    // using localStorage events
    window.addEventListener('storage', (e) => {
      if (e.key === 'vesselUpdate' || e.key === 'routeUpdate') {
        loadAnalytics();
      }
    });
    
    // when page loads
    document.addEventListener('DOMContentLoaded', () => {
      const user = checkAuth();
      if (!user) return;
      
      // show user info
      document.getElementById('userName').textContent = user.name;
      document.getElementById('userRole').textContent = user.role.toUpperCase();
      document.getElementById('userAvatar').textContent = user.name.substring(0, 2).toUpperCase();
      // show admin link if admin
      if (user.role === 'admin') document.getElementById('adminLink').style.display = 'flex';
      
      loadAnalytics();
    });
  </script>
</body>
</html>
